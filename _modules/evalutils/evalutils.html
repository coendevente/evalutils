
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evalutils.evalutils &#8212; evalutils 0.3.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for evalutils.evalutils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">PathLike</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Pattern</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">SimpleITK</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span><span class="p">,</span> <span class="n">concat</span><span class="p">,</span> <span class="n">merge</span>

<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">FileLoaderError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CSVLoader</span><span class="p">,</span>
    <span class="n">FileLoader</span><span class="p">,</span>
    <span class="n">ImageLoader</span><span class="p">,</span>
    <span class="n">SimpleITKLoader</span><span class="p">,</span>
    <span class="n">first_int_in_filename_key</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.scorers</span> <span class="kn">import</span> <span class="n">score_detection</span>
<span class="kn">from</span> <span class="nn">.validators</span> <span class="kn">import</span> <span class="n">DataFrameValidator</span><span class="p">,</span> <span class="n">UniqueImagesValidator</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DEFAULT_INPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/input/&quot;</span><span class="p">)</span>
<span class="n">DEFAULT_ALGORITHM_OUTPUT_IMAGES_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/output/images/&quot;</span><span class="p">)</span>
<span class="n">DEFAULT_ALGORITHM_OUTPUT_FILE_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/output/results.json&quot;</span><span class="p">)</span>
<span class="n">DEFAULT_GROUND_TRUTH_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/opt/evaluation/ground-truth/&quot;</span><span class="p">)</span>
<span class="n">DEFAULT_EVALUATION_OUTPUT_FILE_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/output/metrics.json&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Algorithm"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.Algorithm">[docs]</a><span class="k">class</span> <span class="nc">Algorithm</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="Algorithm.__init__"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.Algorithm.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">index_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;input_image&quot;</span><span class="p">,</span>
        <span class="n">file_loaders</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FileLoader</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_INPUT_PATH</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_ALGORITHM_OUTPUT_IMAGES_PATH</span><span class="p">,</span>
        <span class="n">file_sorter_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validators</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DataFrameValidator</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_file</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="n">DEFAULT_ALGORITHM_OUTPUT_FILE_PATH</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The base class for all algorithms. Sets the environment and controls</span>
<span class="sd">        the flow of the processing once `process` is called.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index_key</span>
<span class="sd">            Fileloader key which must be used for the index.</span>
<span class="sd">            Default: `input_image`</span>
<span class="sd">        file_loaders</span>
<span class="sd">            The loaders that will be used to get all files.</span>
<span class="sd">            Default: `evalutils.io.SimpleITKLoader` for `input_image`</span>
<span class="sd">        file_filters</span>
<span class="sd">            Regular expressions for filtering certain FileLoaders.</span>
<span class="sd">            Default: no filtering.</span>
<span class="sd">        input_path</span>
<span class="sd">            The path in the container where the ground truth will be loaded</span>
<span class="sd">            from. Default: `/input`</span>
<span class="sd">        output_path</span>
<span class="sd">            The path in the container where the output images will be written.</span>
<span class="sd">            Default: `/output/images`</span>
<span class="sd">        file_sorter_key</span>
<span class="sd">            A function that determines how files in the input_path are sorted.</span>
<span class="sd">            Default: `None` (alphanumerical)</span>
<span class="sd">        validators</span>
<span class="sd">            A dictionary containing the validators that will be used on the</span>
<span class="sd">            loaded data per file_loader key. Default:</span>
<span class="sd">            `evalutils.validators.UniqueImagesValidator` for `input_image`</span>
<span class="sd">        output_file</span>
<span class="sd">            The path to the location where the results will be written.</span>
<span class="sd">            Default: `/output/results.json`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_key</span> <span class="o">=</span> <span class="n">index_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_path</span> <span class="o">=</span> <span class="n">input_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_sorter_key</span> <span class="o">=</span> <span class="n">file_sorter_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_file</span> <span class="o">=</span> <span class="n">output_file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DataFrameValidator</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">input_image</span><span class="o">=</span><span class="p">(</span><span class="n">UniqueImagesValidator</span><span class="p">(),))</span>
            <span class="k">if</span> <span class="n">validators</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">validators</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_loaders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FileLoader</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">input_image</span><span class="o">=</span><span class="n">SimpleITKLoader</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">file_loaders</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">file_loaders</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">input_image</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">file_filters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">file_filters</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file_loader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_loaders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fltr</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file_filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_filters</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_cases</span><span class="p">(</span>
                <span class="n">folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_path</span><span class="p">,</span>
                <span class="n">file_loader</span><span class="o">=</span><span class="n">file_loader</span><span class="p">,</span>
                <span class="n">file_filter</span><span class="o">=</span><span class="n">fltr</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_cases</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">file_loader</span><span class="p">:</span> <span class="n">ImageLoader</span><span class="p">,</span>
        <span class="n">file_filter</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_sorter_key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file_filter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">file_filter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_cases</span> <span class="o">=</span> <span class="n">file_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FileLoaderError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not load </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> using </span><span class="si">{</span><span class="n">file_loader</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cases</span> <span class="o">=</span> <span class="n">new_cases</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cases</span> <span class="o">+=</span> <span class="n">new_cases</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Skip loading </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> because it doesn&#39;t match </span><span class="si">{</span><span class="n">file_filter</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">cases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FileLoaderError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not load any files in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> with &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_loader</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span>

<div class="viewcode-block" id="Algorithm.validate"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.Algorithm.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates each dataframe for each fileloader separately&quot;&quot;&quot;</span>
        <span class="n">file_loaders_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_loaders</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_loaders_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;There is no file_loader associated with: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Valid file loaders are: </span><span class="si">{</span><span class="n">file_loaders_keys</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cases</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data_frame</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">cases</span><span class="p">,</span> <span class="n">file_loader_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_validate_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">file_loader_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span><span class="p">[</span><span class="n">file_loader_key</span><span class="p">]:</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_cases</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_loader_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_loader_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_loader_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="p">[</span><span class="n">file_loader_key</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_case</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">))</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">process_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_file</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_input_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
        <span class="n">input_image_file_path</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>

        <span class="n">input_image_file_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_loaders</span><span class="p">[</span><span class="s2">&quot;input_image&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_image_file_loader</span><span class="p">,</span> <span class="n">ImageLoader</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The used FileLoader was not of subclass ImageLoader&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load the image for this case</span>
        <span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image_file_loader</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">input_image_file_path</span><span class="p">)</span>

        <span class="c1"># Check that it is the expected image</span>
        <span class="k">if</span> <span class="n">input_image_file_loader</span><span class="o">.</span><span class="n">hash_image</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span> <span class="o">!=</span> <span class="n">case</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Image hashes do not match&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_image</span><span class="p">,</span> <span class="n">input_image_file_path</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="DetectionAlgorithm"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.DetectionAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">DetectionAlgorithm</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="c1"># Load and test the image for this case</span>
        <span class="n">input_image</span><span class="p">,</span> <span class="n">input_image_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_input_image</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>

        <span class="c1"># Detect and score candidates</span>
        <span class="n">scored_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_image</span><span class="o">=</span><span class="n">input_image</span><span class="p">)</span>

        <span class="c1"># Write resulting candidates to result.json for this case</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;candidates&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">scored_candidates</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
            <span class="p">],</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;metaio_image&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">input_image_file_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;error_messages&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_serialize_candidates</span><span class="p">(</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">candidates</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
        <span class="n">candidate_scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">ref_image</span><span class="p">:</span> <span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">candidate_scores</span><span class="p">):</span>
            <span class="n">world_coords</span> <span class="o">=</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">TransformContinuousIndexToPhysicalPoint</span><span class="p">(</span>
                <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">coord</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">coord_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;coord</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">],</span> <span class="n">world_coords</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">coord_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="SegmentationAlgorithm"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.SegmentationAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">SegmentationAlgorithm</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="c1"># Load and test the image for this case</span>
        <span class="n">input_image</span><span class="p">,</span> <span class="n">input_image_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_input_image</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>

        <span class="c1"># Segment nodule candidates</span>
        <span class="n">segmented_nodules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_image</span><span class="o">=</span><span class="n">input_image</span><span class="p">)</span>

        <span class="c1"># Write resulting segmentation to output location</span>
        <span class="n">segmentation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">/</span> <span class="n">input_image_file_path</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">SimpleITK</span><span class="o">.</span><span class="n">WriteImage</span><span class="p">(</span><span class="n">segmented_nodules</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">segmentation_path</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Write segmentation file path to result.json for this case</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;metaio_image&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">segmentation_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;metaio_image&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">input_image_file_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;error_messages&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="ClassificationAlgorithm"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.ClassificationAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">ClassificationAlgorithm</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="c1"># Load and test the image for this case</span>
        <span class="n">input_image</span><span class="p">,</span> <span class="n">input_image_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_input_image</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>

        <span class="c1"># Classify input_image image</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_image</span><span class="o">=</span><span class="n">input_image</span><span class="p">)</span>

        <span class="c1"># Test classification output</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exepected a dictionary as output&quot;</span><span class="p">)</span>

        <span class="c1"># Write resulting classification to result.json for this case</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">results</span><span class="p">],</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;metaio_image&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">input_image_file_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;error_messages&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="n">SimpleITK</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseEvaluation"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.BaseEvaluation">[docs]</a><span class="k">class</span> <span class="nc">BaseEvaluation</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="BaseEvaluation.__init__"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.BaseEvaluation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">ground_truth_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_GROUND_TRUTH_PATH</span><span class="p">,</span>
        <span class="n">predictions_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_INPUT_PATH</span><span class="p">,</span>
        <span class="n">file_sorter_key</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">first_int_in_filename_key</span><span class="p">,</span>
        <span class="n">file_loader</span><span class="p">:</span> <span class="n">FileLoader</span><span class="p">,</span>
        <span class="n">validators</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DataFrameValidator</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">join_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregates</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_file</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="n">DEFAULT_EVALUATION_OUTPUT_FILE_PATH</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The base class for all evaluations. Sets the environment and controls</span>
<span class="sd">        the flow of the evaluation once `evaluate` is called.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ground_truth_path</span>
<span class="sd">            The path in the container where the ground truth will be loaded</span>
<span class="sd">            from</span>
<span class="sd">        predictions_path</span>
<span class="sd">            The path in the container where the submission will be loaded from</span>
<span class="sd">        file_sorter_key</span>
<span class="sd">            A function that determines how files are sorted and matched</span>
<span class="sd">            together</span>
<span class="sd">        file_loader</span>
<span class="sd">            The loader that will be used to get all files</span>
<span class="sd">        validators</span>
<span class="sd">            A tuple containing all the validators that will be used on the</span>
<span class="sd">            loaded data</span>
<span class="sd">        join_key</span>
<span class="sd">            The column that will be used to join the predictions and ground</span>
<span class="sd">            truth tables</span>
<span class="sd">        aggregates</span>
<span class="sd">            The set of aggregates that will be calculated by</span>
<span class="sd">            `pandas.DataFrame.describe`</span>
<span class="sd">        output_file</span>
<span class="sd">            The path to the location where the results will be written</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">aggregates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aggregates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;std&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;25%&quot;</span><span class="p">,</span>
                <span class="s2">&quot;50%&quot;</span><span class="p">,</span>
                <span class="s2">&quot;75%&quot;</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;uniq&quot;</span><span class="p">,</span>
                <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_path</span> <span class="o">=</span> <span class="n">ground_truth_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_path</span> <span class="o">=</span> <span class="n">predictions_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_sorter_key</span> <span class="o">=</span> <span class="n">file_sorter_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_loader</span> <span class="o">=</span> <span class="n">file_loader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span> <span class="o">=</span> <span class="n">validators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span> <span class="o">=</span> <span class="n">join_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregates</span> <span class="o">=</span> <span class="n">aggregates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_file</span> <span class="o">=</span> <span class="n">output_file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_loader</span><span class="p">,</span> <span class="n">CSVLoader</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You must set a `join_key` when using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_loader</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the calculated case and aggregate results&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s2">&quot;aggregates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_results</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_ground_truth_and_predictions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_cases</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_path</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_cases</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions_path</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_sorter_key</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileLoaderError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not load </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_loader</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cases</span> <span class="o">=</span> <span class="n">new_cases</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cases</span> <span class="o">+=</span> <span class="n">new_cases</span>

        <span class="k">if</span> <span class="n">cases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FileLoaderError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not load any files in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> with &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_loader</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span>

<div class="viewcode-block" id="BaseEvaluation.validate"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.BaseEvaluation.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates each dataframe separately&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data_frame</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data_frame</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_validate_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span><span class="p">:</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">merge_ground_truth_and_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="BaseEvaluation.cross_validate"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.BaseEvaluation.cross_validate">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">cross_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates both dataframes&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_raise_missing_predictions_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Predictions missing: you did not submit predictions for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">. Please try again.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Predictions missing: you did not submit enough predictions, &quot;</span>
                <span class="s2">&quot;please try again.&quot;</span>
            <span class="p">)</span>

        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_raise_extra_predictions_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Too many predictions: we do not have the ground truth data &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">. Please try again.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Too many predictions: you submitted too many predictions, &quot;</span>
                <span class="s2">&quot;please try again.&quot;</span>
            <span class="p">)</span>

        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># noinspection PyUnusedLocal</span>
    <span class="k">def</span> <span class="nf">score_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">score_aggregates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">aggregate_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">aggregate_results</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_series</span><span class="p">(</span>
                <span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">aggregate_results</span>

    <span class="k">def</span> <span class="nf">aggregate_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
        <span class="n">valid_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregates</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">]</span>

        <span class="n">series_summary</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># % in keys could cause problems when looking up values later</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not serialize </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> as json, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;so converting </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to int.&quot;</span>
                <span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">series_summary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">series_summary</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">))</span></div>


<div class="viewcode-block" id="ClassificationEvaluation"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.ClassificationEvaluation">[docs]</a><span class="k">class</span> <span class="nc">ClassificationEvaluation</span><span class="p">(</span><span class="n">BaseEvaluation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ClassificationEvaluations have the same number of predictions as the</span>
<span class="sd">    number of ground truth cases. These can be things like, what is the</span>
<span class="sd">    stage of this case, or segment some things in this case.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">merge_ground_truth_and_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;left_index&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;right_index&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span><span class="p">,</span>
            <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_ground_truth&quot;</span><span class="p">,</span> <span class="s2">&quot;_prediction&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ClassificationEvaluation.cross_validate"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.ClassificationEvaluation.cross_validate">[docs]</a>    <span class="k">def</span> <span class="nf">cross_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">p</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left_only&quot;</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_missing_predictions_error</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">)</span>

        <span class="n">extra</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">p</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;right_only&quot;</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_extra_predictions_error</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">score_case</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_aggregates</span><span class="p">()</span></div>


<div class="viewcode-block" id="Evaluation"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.Evaluation">[docs]</a><span class="k">class</span> <span class="nc">Evaluation</span><span class="p">(</span><span class="n">ClassificationEvaluation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Legacy class, you should use ClassificationEvaluation instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Evaluation.__init__"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.Evaluation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;The Evaluation class is deprecated, &quot;</span>
                <span class="s2">&quot;please use ClassificationEvaluation instead&quot;</span>
            <span class="p">),</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DetectionEvaluation"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.DetectionEvaluation">[docs]</a><span class="k">class</span> <span class="nc">DetectionEvaluation</span><span class="p">(</span><span class="n">BaseEvaluation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DetectionEvaluations have a different number of predictions from the</span>
<span class="sd">    number of ground truth annotations. An example would be detecting lung</span>
<span class="sd">    nodules in a CT volume, or malignant cells in a pathology slide.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DetectionEvaluation.__init__"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.DetectionEvaluation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">detection_radius</span><span class="p">,</span> <span class="n">detection_threshold</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detection_radius</span> <span class="o">=</span> <span class="n">detection_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detection_threshold</span> <span class="o">=</span> <span class="n">detection_threshold</span></div>

    <span class="k">def</span> <span class="nf">merge_ground_truth_and_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cases</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span><span class="p">],</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ground_truth&quot;</span><span class="p">,</span> <span class="s2">&quot;predictions&quot;</span><span class="p">],</span>
        <span class="p">)</span>

<div class="viewcode-block" id="DetectionEvaluation.cross_validate"><a class="viewcode-back" href="../../modules.html#evalutils.evalutils.DetectionEvaluation.cross_validate">[docs]</a>    <span class="k">def</span> <span class="nf">cross_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">])</span>
        <span class="n">submitted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">])</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="n">expected_keys</span> <span class="o">-</span> <span class="n">submitted_keys</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_missing_predictions_error</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">)</span>

        <span class="n">extra</span> <span class="o">=</span> <span class="n">submitted_keys</span> <span class="o">-</span> <span class="n">expected_keys</span>
        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_extra_predictions_error</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_raise_extra_predictions_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In detection challenges extra predictions are ok&quot;&quot;&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are extra predictions for cases: </span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_raise_missing_predictions_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In detection challenges missing predictions are ok&quot;&quot;&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find predictions for cases: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ground_truth_cases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">])</span>
        <span class="n">cases</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions_cases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cases</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">score_case</span><span class="p">(</span>
                    <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                    <span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">case</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_aggregates</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">score_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score_detection</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_points</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ground_truth&quot;</span><span class="p">),</span>
            <span class="n">predictions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_points</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">),</span>
            <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_detection_radius</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add the case id to the score</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">:</span> <span class="n">case</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">get_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">score_aggregates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">aggregate_results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">score_aggregates</span><span class="p">()</span>

        <span class="n">totals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_results</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;true_positives&quot;</span><span class="p">,</span> <span class="s2">&quot;false_positives&quot;</span><span class="p">,</span> <span class="s2">&quot;false_negatives&quot;</span><span class="p">]:</span>
            <span class="n">aggregate_results</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

        <span class="n">tp</span> <span class="o">=</span> <span class="n">aggregate_results</span><span class="p">[</span><span class="s2">&quot;true_positives&quot;</span><span class="p">][</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">aggregate_results</span><span class="p">[</span><span class="s2">&quot;false_positives&quot;</span><span class="p">][</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">aggregate_results</span><span class="p">[</span><span class="s2">&quot;false_negatives&quot;</span><span class="p">][</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span>

        <span class="n">aggregate_results</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span>
        <span class="n">aggregate_results</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
        <span class="n">aggregate_results</span><span class="p">[</span><span class="s2">&quot;f1_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span><span class="p">)</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aggregate_results</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">evalutils</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, James Meakin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>